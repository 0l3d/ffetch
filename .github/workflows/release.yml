name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  create:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libxcb1-dev libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev libxcb-shm0-dev libx11-dev

    - name: Build
      run: cargo build --release

    - name: Create archive
      run: |
        BINARY_NAME=$(grep '^name = ' Cargo.toml | head -1 | cut -d '"' -f2)
        mkdir release
        cp target/release/$BINARY_NAME release/
        [ -f README.md ] && cp README.md release/
        [ -f LICENSE ] && cp LICENSE release/
        tar -czf $BINARY_NAME-linux.tar.gz -C release .

    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        files: "*.tar.gz"
